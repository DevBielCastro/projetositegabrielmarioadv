<!DOCTYPE html>
<html lang="pt-BR" x-data="admin()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Gabriel Mário Adv</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.13.5/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 font-sans">
    
    <!-- Cabeçalho Admin -->
    <nav class="bg-primary/90 backdrop-blur">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="/assets/img/logo-dourada-transparente.webp" alt="Admin" class="h-16">
                <span class="text-gold font-semibold">Painel de Artigos</span>
            </div>
            <button @click="logout()" class="text-gold hover:text-accent">
                <i class="fas fa-sign-out-alt mr-2"></i>Sair
            </button>
        </div>
    </nav>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto px-4 py-8">
        <!-- Botão Novo Artigo -->
        <div class="mb-8 flex justify-end">
            <button @click="newPost()" class="bg-accent text-white px-6 py-2 rounded-lg hover:bg-gold transition">
                <i class="fas fa-plus mr-2"></i>Novo Artigo
            </button>
        </div>

        <!-- Lista de Artigos -->
        <div id="postsList" class="grid gap-6"></div>

        <!-- Formulário de Edição -->
        <div x-show="editing" x-transition class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <form @submit.prevent="savePost()" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2">Título</label>
                            <input x-model="currentPost.title" type="text" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-accent">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Categoria</label>
                            <select x-model="currentPost.category" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-accent">
                                <option value="Direito Médico">Direito Médico</option>
                                <option value="Direito Imobiliário">Direito Imobiliário</option>
                                <option value="Direito Previdenciário">Direito Previdenciário</option>
                                <option value="Direito Civil">Direito Civil</option>
                                <option value="Direito do Trabalho">Direito do Trabalho</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2">Resumo</label>
                        <textarea x-model="currentPost.excerpt" required rows="3"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-accent"></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2">Conteúdo (HTML)</label>
                        <textarea x-model="currentPost.content" required rows="10"
                            class="w-full px-4 py-2 border rounded-lg font-mono text-sm focus:ring-2 focus:ring-accent"></textarea>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2">URL da Imagem</label>
                            <input x-model="currentPost.thumbnail" type="url"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-accent">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Status</label>
                            <select x-model="currentPost.status" required
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-accent">
                                <option value="draft">Rascunho</option>
                                <option value="published">Publicado</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button type="button" @click="cancelEdit()"
                            class="px-6 py-2 text-gray-600 hover:text-accent">Cancelar</button>
                        <button type="submit"
                            class="bg-accent text-white px-6 py-2 rounded-lg hover:bg-gold transition">
                            Salvar Artigo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('admin', () => ({
                editing: false,
                currentPost: {},
                posts: [],

                init() {
                    this.verifyAuth();
                    this.loadPosts();
                },

                async verifyAuth() {
                    try {
                        const token = document.cookie.match(/token=([^;]*)/)?.[1];
                        if (!token) throw new Error('Não autenticado');

                        const response = await fetch('/api/posts', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (!response.ok) throw new Error('Token inválido');
                    } catch (error) {
                        window.location.href = '/login';
                    }
                },

                async loadPosts() {
                    try {
                        const token = document.cookie.match(/token=([^;]*)/)?.[1];
                        const response = await fetch('/api/posts', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        this.posts = await response.json();
                    } catch (error) {
                        console.error('Erro ao carregar posts:', error);
                    }
                },

                newPost() {
                    this.currentPost = {
                        title: '',
                        content: '',
                        excerpt: '',
                        category: 'Direito Civil',
                        thumbnail: '',
                        status: 'draft'
                    };
                    this.editing = true;
                },

                async savePost() {
                    try {
                        const token = document.cookie.match(/token=([^;]*)/)?.[1];
                        const method = this.currentPost._id ? 'PUT' : 'POST';
                        const url = this.currentPost._id 
                            ? `/api/posts/${this.currentPost._id}`
                            : '/api/posts';

                        const response = await fetch(url, {
                            method,
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.currentPost)
                        });

                        if (response.ok) {
                            this.editing = false;
                            await this.loadPosts();
                        }
                    } catch (error) {
                        console.error('Erro ao salvar post:', error);
                    }
                },

                cancelEdit() {
                    this.editing = false;
                },

                logout() {
                    document.cookie = 'token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                    window.location.href = '/login';
                }
            }));
        });
    </script>
</body>
</html>